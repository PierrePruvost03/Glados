name: Release
run-name: Releasing Glados

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  release_project:
    name: Release
    runs-on: ubuntu-latest
    container:
      image: epitechcontent/epitest-docker
    env:
      STACK_ROOT: /tmp/stack-root
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure Git security
        run: git config --global --add safe.directory /__w/Glados/Glados
      - name: Build project
        run: make
      - name: Extract tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      - name: Extract release notes from tag message
        id: release_notes
        run: |
          echo "Tag: ${{ steps.tag.outputs.tag }}"
          git tag -l
          
          TAG_MESSAGE=$(git show ${{ steps.tag.outputs.tag }} --format=%B --no-patch 2>/dev/null || echo "")
          
          if [ -z "$TAG_MESSAGE" ]; then
            TAG_MESSAGE=$(git cat-file tag ${{ steps.tag.outputs.tag }} 2>/dev/null | sed '1,/^$/d' || echo "")
          fi
          
          if [ -z "$TAG_MESSAGE" ]; then
            TAG_MESSAGE=$(git log -1 --pretty=%B)
          fi
          
          echo "Debug TAG_MESSAGE:"
          echo "$TAG_MESSAGE"
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Glados ${{ steps.tag.outputs.tag }}"
          body: ${{ steps.release_notes.outputs.notes }}
          files: |
            glados
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOWS_TOKEN }}